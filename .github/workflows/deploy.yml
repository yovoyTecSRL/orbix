#!/bin/bash

### ğŸ§¹ Script de Limpieza y ResoluciÃ³n de Conflictos para ORBIX ###
### Autor: Orbix AI â€“ 2025 ###

set -e

BRANCH_MAIN="main"
BRANCH_BACKUP="proceso-creacion-orbix"

# Paso 1: Confirmar rama actual y guardar cambios
current_branch=$(git rev-parse --abbrev-ref HEAD)
echo "ğŸŒ¿ Rama actual: $current_branch"

echo "ğŸ’¾ Guardando cambios temporales si existen..."
git stash save "ğŸ”§ Backup automÃ¡tico antes de limpiar" || true

# Paso 2: Cambiar a rama principal y actualizar
echo "ğŸ” Cambiando a rama $BRANCH_MAIN"
git checkout $BRANCH_MAIN

echo "ğŸ“¥ Pull de cambios remotos"
git pull origin $BRANCH_MAIN

# Paso 3: Borrar archivos duplicados, backups y temporales
echo "ğŸ§½ Eliminando archivos innecesarios..."
rm -f ssh_setup_github_hetzner\ \(1\).sh orbix-sentinel.txt
rm -f *.tar.gz *.zip *.bak || true
rm -rf __pycache__

# Paso 4: Limpiar archivos no registrados por Git
echo "ğŸ§¹ git clean"
git clean -f -d

# Paso 5: Resolver conflictos si quedaron marcados
if grep -q '<<<<<<<' main.py 2>/dev/null || grep -q '<<<<<<<' requirements.txt 2>/dev/null; then
  echo "âš ï¸ AÃºn hay conflictos en main.py o requirements.txt. Por favor edÃ­talos manualmente."
  exit 1
fi

# Paso 6: Commit de limpieza y push a main
git add .
git commit -m "ğŸ§¹ Limpieza automÃ¡tica de archivos y resoluciÃ³n preliminar"
git push origin $BRANCH_MAIN

# Paso 7: Actualizar rama de respaldo
echo "ğŸ“¦ Fusionando en rama de respaldo $BRANCH_BACKUP"
git checkout $BRANCH_BACKUP
git pull origin $BRANCH_BACKUP
git merge $BRANCH_MAIN || true

echo "ğŸ“¤ Enviando respaldo actualizado..."
git push origin $BRANCH_BACKUP

# Paso 8: Restaurar stash si habÃ­a
if git stash list | grep -q "Backup automÃ¡tico"; then
  echo "â™»ï¸ Restaurando cambios stashed..."
  git stash pop || true
fi

echo "âœ… Limpieza y sincronizaciÃ³n completa."
