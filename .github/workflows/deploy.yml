name: ğŸš€ Deploy Orbix AI to Hetzner

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸ“¦ Build and Deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ—ï¸ Build Docker image
      run: |
        echo "ğŸ”¨ Building Orbix AI Docker image..."
        docker build -t orbix-ai:latest .
        docker save orbix-ai:latest | gzip > orbix-ai.tar.gz
        
    - name: ğŸ“¤ Deploy to Hetzner Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HETZNER_IP }}
        username: root
        key: ${{ secrets.HETZNER_SSH_KEY }}
        port: 22
        timeout: 300s
        script: |
          echo "ğŸš€ Starting deployment process..."
          
          # Crear directorio si no existe
          mkdir -p /opt/orbix
          cd /opt/orbix
          
          # Backup de la versiÃ³n anterior
          if [ -f docker-compose.yml ]; then
            echo "ğŸ’¾ Creating backup..."
            docker-compose down || true
            cp docker-compose.yml docker-compose.yml.backup.$(date +%Y%m%d_%H%M%S) || true
          fi
          
          # Actualizar cÃ³digo desde GitHub
          if [ -d .git ]; then
            echo "ğŸ”„ Updating from GitHub..."
            git fetch origin
            git reset --hard origin/main
          else
            echo "ğŸ“¥ Cloning repository..."
            git clone https://github.com/yovoyTecSRL/orbix.git .
          fi
          
          # Asegurar permisos
          chmod +x *.sh || true
          
          # Detener contenedores anteriores
          echo "ğŸ›‘ Stopping previous containers..."
          docker-compose down || true
          docker stop orbix-ai || true
          docker rm orbix-ai || true
          
          # Limpiar imÃ¡genes antiguas
          echo "ğŸ§¹ Cleaning old images..."
          docker image prune -f || true
          
          # Construir y ejecutar
          echo "ğŸ—ï¸ Building and starting new containers..."
          docker-compose build --no-cache
          docker-compose up -d
          
          # Verificar estado
          echo "âœ… Checking deployment status..."
          sleep 10
          docker-compose ps
          docker-compose logs --tail=20
          
          # Test de conectividad
          echo "ğŸ” Testing connectivity..."
          curl -f http://localhost/ || echo "âš ï¸ Warning: Service might still be starting..."
          
          echo "ğŸ‰ Deployment completed successfully!"
          
    - name: ğŸ”” Deployment Status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "âœ… Deployment successful! ğŸ‰"
        else
          echo "âŒ Deployment failed! ğŸ˜"
        fi
