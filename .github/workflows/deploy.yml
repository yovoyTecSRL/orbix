
name: ğŸš€ Deploy Orbix AI to Hetzner

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸ“¦ Build and Deploy Orbix AI
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ› ï¸ Build Docker Image
      run: |
        echo "ğŸ”¨ Building Orbix AI Docker image..."
        docker build --pull --no-cache -t orbix-ai:latest .
        docker save orbix-ai:latest | gzip > orbix-ai.tar.gz

    - name: ğŸ“¤ Deploy to Hetzner
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HETZNER_IP }}
        username: root
        key: ${{ secrets.HETZNER_SSH_KEY }}
        port: 22
        timeout: 300s
        script: |
          set -e
          echo "ğŸš€ Connecting to Hetzner..."

          # Preparar entorno
          mkdir -p /opt/orbix && cd /opt/orbix

          # Backup
          if [ -f docker-compose.yml ]; then
            echo "ğŸ’¾ Backing up docker-compose.yml..."
            docker-compose down || true
            cp docker-compose.yml docker-compose.backup.$(date +%Y%m%d_%H%M%S).yml || true
          fi

          # Git sync
          if [ ! -d .git ]; then
            git clone https://github.com/yovoyTecSRL/orbix.git .
          else
            git fetch origin
            git reset --hard origin/main
          fi

          # Dar permisos
          chmod +x *.sh || true

          # Detener y limpiar
          docker-compose down || true
          docker rm -f orbix-ai || true
          docker image prune -af || true

          # Build & deploy
          echo "ğŸš€ Rebuilding containers..."
          docker-compose build --no-cache
          docker-compose up -d

          # VerificaciÃ³n
          echo "âœ… Containers running:"
          docker ps
          echo "ğŸ“„ Ãšltimos logs:"
          docker-compose logs --tail=30 || true

          # Test automÃ¡tico
          if [ -f test_deployment.sh ]; then
            echo "ğŸ§ª Running deployment tests..."
            chmod +x test_deployment.sh
            ./test_deployment.sh
          else
            echo "ğŸ” Quick test: curl localhost"
            curl -f http://localhost/ || echo "âš ï¸ Could not connect yet."
          fi

          echo "âœ… Deployment completed!"

    - name: ğŸ”” Notify Deployment Status
      if: always()
      run: |
        echo "ğŸ“¡ Deployment status: ${{ job.status }}"
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… Orbix AI deployed successfully to Hetzner!"
        else
          echo "âŒ Deployment failed. Please check the logs."
        fi
